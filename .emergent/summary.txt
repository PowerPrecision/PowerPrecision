<analysis>**original_problem_statement:**
O utilizador iniciou o projeto para reativar uma integração Trello. Ao longo do tempo, os requisitos expandiram-se para incluir:
- Sincronização de dados do Trello (descrição, atividades, etiquetas, membros, prazos).
- Um sistema de visualização de emails.
- Atribuição manual de processos a utilizadores.
- Integração com o OneDrive para visualização de documentos.
- Funcionalidade de análise de documentos com IA para preencher automaticamente as fichas dos clientes, incluindo um modo de upload massivo.
- O requisito mais recente é alinhar o ambiente de desenvolvimento com um repositório GitHub e uma base de dados MongoDB de produção, em preparação para o deployment.

PRODUCT REQUIREMENTS:
- A aplicação deve funcionar como um espelho de um quadro Trello, com funcionalidades adicionais de gestão.
- A visibilidade dos processos deve ser controlada por papéis de utilizador (admin, consultor, intermediario) e atribuições.
- A integração com o OneDrive deve permitir o acesso aos documentos dos clientes.
- A análise de documentos com IA deve ser robusta, suportando uploads massivos, processamento em fila, tratamento de erros, e ser capaz de lidar com vários tipos de documentos (incluindo PDFs digitalizados e junção de ficheiros como CC frente/verso).
- O sistema deve ser resiliente a erros de API (ex: rate limits) e otimizado para não sobrecarregar o browser do utilizador.
- O ambiente final deve estar sincronizado com o repositório GitHub do utilizador e a base de dados de produção.

**User's preferred language**: Portuguese (Portugal). O próximo agente DEVE comunicar exclusivamente em português de Portugal.

**what currently exists?**
Uma aplicação full-stack (React/FastAPI/MongoDB) que espelha um quadro Trello com funcionalidades de gestão avançadas.
- **Funcionalidades Principais:** Autenticação de utilizadores, Kanban com visibilidade por papel/atribuição, dialog de atribuição de processos, página de detalhes do processo, e um painel de histórico de emails.
- **Integração Trello:** Sincronização de dados, mapeamento manual de membros e importação de comentários/atividades.
- **Integração OneDrive:** Utiliza um workaround com um link de partilha para gerar URLs de pesquisa para as pastas dos clientes, devido a restrições de permissão da API Graph.
- **Análise de Documentos com IA:**
    - Uma funcionalidade na ficha do cliente para upload de um único documento (via ficheiro ou URL) que a IA analisa para preencher dados.
    - Uma funcionalidade de **upload massivo** para administradores, que processa uma estrutura de pastas (uma por cliente), analisa todos os documentos e atualiza as fichas dos clientes.
- **Melhorias Recentes (Robustez e Performance):**
    - O upload massivo foi refatorizado para processar ficheiros em fila (um de cada vez) para evitar sobrecarregar o browser.
    - O frontend exibe uma barra de progresso individual por ficheiro usando Server-Sent Events (SSE).
    - O backend suporta subpastas dentro da pasta de um cliente.
    - Foi implementada uma verificação prévia para ignorar ficheiros de clientes não existentes no sistema, otimizando o processo.
    - O sistema junta automaticamente ficheiros de Cartão de Cidadão (frente e verso) num único PDF antes da análise.
    - PDFs sem texto (digitalizados) são convertidos em imagens usando  para análise via API de visão.
    - Foi adicionado um mecanismo de retry com  para gerir erros de rate limit (429) da API da IA.

**Last working item**:
    - Last item agent was working: O agente foi encarregado de sincronizar a aplicação com um repositório GitHub e uma base de dados MongoDB de produção fornecidos pelo utilizador. O agente clonou o repositório para  e começou a comparar os ficheiros, identificando diferenças significativas entre o código local (com as funcionalidades de IA mais recentes) e o código no GitHub. A tarefa foi interrompida antes de decidir como reconciliar estas diferenças ou de ligar à nova base de dados.
    - Status: IN PROGRESS
    - Agent Testing Done: N
    - Which testing method agent to use? Manual verification and regression testing. Após a sincronização, o agente deve verificar se a aplicação funciona com a nova base de dados e o código reconciliado. Recomenda-se chamar o  para um teste completo, dado o risco da operação.
    - User Testing Done: N

**All Pending/In progress Issue list**:
  - Todas as issues mencionadas em forks anteriores (bugs de UI no Kanban, formato de email, funcionalidade de atribuição) foram resolvidas e verificadas nesta sessão. Não há issues pendentes conhecidas para além da tarefa em progresso.

**In progress Task List**:
  - Task 1:  (P0) Sincronizar a aplicação com o repositório GitHub e a base de dados de produção.

 Task Detail:
  - Task 1: 
     - **Where to resume**: O agente já clonou o repositório e identificou discrepâncias (o código local está mais avançado). O próximo passo é apresentar estas diferenças ao utilizador e perguntar como proceder. As opções são:
         1.  **Ignorar o GitHub:** Manter o código local atual e apenas mudar a ligação da base de dados.
         2.  **Sobrescrever com GitHub:** Perder todas as melhorias recentes de IA.
         3.  **Sugerir ao utilizador que atualize o GitHub:** A opção mais segura.
         Após a decisão sobre o código, o agente deve atualizar a variável  no ficheiro  com a string de ligação fornecida pelo utilizador e reiniciar o backend.
     - **What will be achieved with this?** A aplicação no ambiente de desenvolvimento estará a correr com o código desejado e ligada à base de dados de produção, preparando-a para o deployment final.
     - **Status:** IN PROGRESS
     - **Should Test frontend/backend/both after fix?** Both
     - **Blocked on something:** Decisão do utilizador sobre como reconciliar as diferenças entre o código local e o do repositório GitHub.

**Upcoming and Future Tasks**
    Upcoming Tasks (P1):
    - **Dashboard de Gestão:** Criar um dashboard com KPIs e métricas de desempenho.
    - **Relatórios PDF:** Implementar a funcionalidade de exportar um resumo do processo para um ficheiro PDF.

    Future Tasks (P2 - Backlog):
    - **Melhorias no Sistema de Documentos:** Verificação de validade e alertas para documentos antigos.
    - **Faturação:** Preparar a aplicação para funcionalidades de faturação.

**Completed work in this session**
- **Correção de Bug de UI no Kanban:** Resolvido o problema dos botões de ação que desapareciam em cartões com nomes longos.
- **Finalização da Integração OneDrive (Frontend):** Adicionado o botão para aceder à pasta do cliente no OneDrive.
- **Correção de Bug de Formato de Email:** Corrigido o problema de emails guardados com formatação markdown na base de dados (tanto no campo de email como nas notas).
- **Nova Funcionalidade: Importação de Comentários do Trello:** Implementado um endpoint e um botão na UI para importar todas as atividades e comentários do Trello para a aplicação.
- **Nova Funcionalidade: Análise de Documentos com IA:** Implementado um analisador de documentos (CC, Recibo, IRS, etc.) na ficha do cliente para extrair e preencher dados automaticamente.
- **Nova Funcionalidade: Upload Massivo com IA:** Criada uma ferramenta para administradores que processa em lote uma pasta de documentos de vários clientes, preenchendo as suas fichas automaticamente.
- **Melhorias de Robustez e Performance:**
    - Otimizado o upload massivo para usar uma fila sequencial e feedback em tempo real com SSE.
    - Adicionado suporte para subpastas, junção de ficheiros de CC (frente/verso), conversão de PDF para imagem () e retentativas de API ().
    - Implementada uma verificação para ignorar ficheiros de clientes não existentes.
- **Refatoração:** Eliminado o ficheiro de serviço obsoleto  e movida a lógica de negócio das rotas para os serviços de IA.

**Code Architecture**


**Key Technical Concepts**
- Backend: FastAPI, Pydantic, Motor (MongoDB)
- Frontend: React, Tailwind CSS, Shadcn UI
- **Novas Tecnologias/Padrões:**
    - Server-Sent Events (SSE) para comunicação em tempo real do backend para o frontend.
    -  para manipulação de PDFs (conversão para imagem).
    -  para combinar imagens num único PDF.
    -  para implementar uma política de retentativas (retry) com exponential backoff em chamadas de API.
    - Processamento de ficheiros em fila no frontend para evitar sobrecarga do browser.
    - Fuzzy string matching () para identificar tipos de ficheiros (ex: CC frente, CC verso).

**key DB schema**
  - **processes**: Não foram criadas novas coleções, mas o schema desta coleção foi enriquecido com múltiplos campos sob as chaves , , e , preenchidos pela análise de IA.

**changes in tech stack**
  - Novas dependências Python: , , , .

**All files of reference**
- : Precisa de ser atualizado com a nova .
- : O repositório GitHub clonado para comparação.
- : Ficheiro central para a funcionalidade de upload massivo.
- : Componente de frontend para a funcionalidade de upload massivo.
- : Contém a lógica principal da análise de IA.

**Areas that need refactoring**:
- O código foi significativamente refatorado durante a sessão, movendo a lógica das rotas para os serviços. A principal tarefa pendente não é de refatoração, mas de sincronização.

**key api endpoints**
- : Importa comentários do Trello.
- : Analisa um único documento enviado via upload.
- : Processa um único ficheiro da fila de upload massivo.
- : Verifica se um cliente existe antes do processamento.
- : Endpoint SSE que envia atualizações de progresso do upload massivo.

**Critical Info for New Agent**
- **Tarefa Imediata:** A prioridade máxima é a sincronização com o GitHub e a base de dados de produção. O código local é **mais recente e avançado** que o do repositório GitHub. **NÃO sobrescreva o código local sem a confirmação explícita do utilizador.** A abordagem mais segura é apresentar as diferenças e perguntar como proceder.
- **Credenciais:** O utilizador forneceu a URL do repositório () e a string de ligação da MongoDB ().
- **Deployment:** O utilizador mencionou que pretende colocar a aplicação online após esta sincronização, o que torna a estabilidade e a escolha correta do código ainda mais críticas.

**documents and test reports created in this job**
  -  (Atualizado).

**Last 10 User Messages and any pending HUMAN messages** 
- **10. Pedido de Sincronização:** O utilizador pediu para atualizar a aplicação com o código de um repositório GitHub e ligar a uma base de dados MongoDB de produção, fornecendo as URLs.
- **9. Pedido de Otimização:** Sugeriu otimizar o upload massivo, verificando se o cliente existe antes de ler os seus documentos para poupar tempo. (Implementado)
- **8. Pergunta sobre Persistência de Dados:** Perguntou se os dados extraídos pela IA são guardados na base de dados. (Confirmado que sim)
- **7. Pedido de Melhorias na Análise IA:** Solicitou a junção de ficheiros de CC (frente/verso) e a capacidade de processar PDFs digitalizados (sem texto). (Implementado)
- **6. Pedido de Melhoria de Robustez:** Sugeriu adicionar um mecanismo de retry () para lidar com erros de rate limit (429) da API de IA. (Implementado)
- **5. Confirmação e Pedido de Deployment:** Confirmou a estrutura de pastas para o upload massivo, o requisito de ser admin, e perguntou o que precisa de fazer para colocar a aplicação online.
- **4. Pergunta sobre Upload Massivo:** Perguntou se era possível fazer um upload massivo de documentos. (Implementado)
- **3. Pedido de Análise Automática do OneDrive:** Pediu para a IA ler os documentos diretamente do OneDrive. Após o agente explicar as limitações técnicas, o utilizador optou por uma solução de upload manual.
- **2. Correção de Bug:** Reportou que o link do OneDrive estava errado e forneceu o link correto. (Corrigido)
- **1. Correção de Bug:** Reportou que o formato do email continuava errado noutros campos, como nas notas. (Corrigido)

**Project Health Check:**
- **Broken:** Nada está funcionalmente quebrado, mas a aplicação está num estado de transição, aguardando a sincronização com o código-fonte final e a base de dados de produção.
- **Mocked:** Nenhuma.

**3rd Party Integrations**
- **Trello:** Sincronização de quadros, cartões e comentários.
- **Servidores de Email (IMAP/SMTP):** Integração ativa.
- **OneDrive:** Integração via workaround (link de partilha para gerar URLs de pesquisa), pois a autenticação OAuth completa foi bloqueada por falta de permissões.
- **Emergent LLM Key:** Usada para aceder à API do  para a análise de documentos.

**Testing status**
  - Testing agent used after significant changes: NO
  - Troubleshoot agent used after agent stuck in loop: NO
  - Test files created: []
  - Known regressions: Nenhuma.

**Credentials to test flow:**
- **Admin:**  / (obter de  env var, default: )
- **MongoDB de Produção:**  (Fornecida pelo utilizador)

**What agent forgot to execute**
- O agente não concluiu a tarefa de sincronização com o GitHub e MongoDB. Ele iniciou a análise, mas não apresentou as descobertas (diferenças de código) ao utilizador para obter uma decisão sobre como proceder.</analysis>
